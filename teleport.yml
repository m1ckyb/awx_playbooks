- hosts: teleport_nodes
  gather_facts: no

  tasks:
  - name: See if teleport.yaml exists
    register: teleport_required_file
    stat:
      path: /etc/teleport.yaml
      
  - name: Copy file with owner and permissions
    ansible.builtin.copy:
      src: /scripts/teleport-repo.sh
      dest: /opt/teleport-repo.sh
      owner: root
      group: root
      mode: '0644'     
    when: not teleport_required_file.stat.exists      
      
  - name: Changing perm of "/opt/teleport-repo.sh", adding "+x"
    file:
      dest: /opt/teleport-repo.sh
      mode: a+x
    when: not teleport_required_file.stat.exists      

  - name: Start the DB batch upload
    become: yes
    async: 10
    poll: 0
    shell:
       "/opt/teleport-repo.sh"
    when: not teleport_required_file.stat.exists
   
  - name: Ansible Update Cache and install teleport
    apt:
      name: teleport
      state: present
      update_cache: yes    
    when: not teleport_required_file.stat.exists            
